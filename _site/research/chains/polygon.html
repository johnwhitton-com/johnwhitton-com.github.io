<!doctype html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Polygon | John Whitton’s Site</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Polygon" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Overview" />
<meta property="og:description" content="Overview" />
<link rel="canonical" href="http://localhost:4000/research/chains/polygon.html" />
<meta property="og:url" content="http://localhost:4000/research/chains/polygon.html" />
<meta property="og:site_name" content="John Whitton’s Site" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-02-04T00:00:00-08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Polygon" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-02-04T00:00:00-08:00","datePublished":"2023-02-04T00:00:00-08:00","description":"Overview","headline":"Polygon","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/research/chains/polygon.html"},"url":"http://localhost:4000/research/chains/polygon.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/styles.css?v=">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    
<!-- <link rel="stylesheet" href="/assets/css/katex.min.css"> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
</head>

<body>
    <div class="wrapper">
        <header>
            <a href="/index.html"><img src="/assets/images/jincubator.png"></a>
            <ul>
                <li><a href="/research">John's Research</a></li>
            </ul>
            <ul>
                <li><a href="/research/primitives/intro.html">Primitives</a></li>
                <ul>
                    
                    
                    <li><a href="/research/primitives/fast-fourier-transformations.html">Fast Fourier Transforms</a></li>
                    
                    <li><a href="/research/primitives/fraud-proofs.html">Fraud Proofs</a></li>
                    
                    <li><a href="/research/primitives/light-clients.html">Light Clients</a></li>
                    
                    <li><a href="/research/primitives/primitives.html">Cryptographic Primitives</a></li>
                    
                    <li><a href="/research/primitives/weak-subjectivity.html">Weak Subjectivity</a></li>
                    
                    <li><a href="/research/primitives/signatures.html">Signature Schemes in Consensus Protocols</a></li>
                    
                </ul>
            </ul>
            <ul>
                <li><a href="/research/zk/intro.html">Zero Knowledge</a></li>
                <ul>
                    
                    
                    <li><a href="/research/zk/zkpos.html">ZK Proof of Stake</a></li>
                    
                    <li><a href="/research/zk/zksnarks.html">zk-SNARKs</a></li>
                    
                </ul>
            </ul>
            <ul>
                <li><a href="/research/bridge/intro.html">Cross-chain Bridges</a></li>
                <ul>
                    
                    
                    <li><a href="/research/bridge/cosmos-ibc.html">Cosmos IBC</a></li>
                    
                    <li><a href="/research/bridge/harmony-horizon.html">Harmony Horizon</a></li>
                    
                    <li><a href="/research/bridge/isomorph.html">Isomorph</a></li>
                    
                    <li><a href="/research/bridge/near-rainbow.html">Near Rainbow Bridge</a></li>
                    
                    <li><a href="/research/bridge/polymerlabs.html">Polymer Labs</a></li>
                    
                    <li><a href="/research/bridge/snowbridge.html">Snowbridge</a></li>
                    
                    <li><a href="/research/bridge/succinct.html">Succinct Labs</a></li>
                    
                </ul>
            </ul>
            <ul>
                <li><a href="/research/chains/intro.html">Layer 1 Platforms</a></li>
                <ul>
                    
                    
                    <li><a href="/research/chains/avalanche.html">Avalanche</a></li>
                    
                    <li><a href="/research/chains/binance.html">Binance Smart Chain</a></li>
                    
                    <li><a href="/research/chains/cosmos.html">Cosmos</a></li>
                    
                    <li><a href="/research/chains/ethereum-1-0.html">Ethereum 1.0</a></li>
                    
                    <li><a href="/research/chains/ethereum.html">Ethereum</a></li>
                    
                    <li><a href="/research/chains/harmony.html">Harmony</a></li>
                    
                    <li><a href="/research/chains/near.html">NEAR</a></li>
                    
                    <li><a href="/research/chains/polkadot.html">Polkadot</a></li>
                    
                    <li><a href="/research/chains/polygon.html">Polygon</a></li>
                    
                </ul>
            </ul>
            <!-- <ul>
                <li><a href="/research/defi/intro.html">Decentralized Finance</a></li>
                <ul>
                    
                    
                </ul>
            </ul> -->
            <!-- <ul>
                <li><a href="/research/gaming/intro.html">Gaming</a></li>
                <ul>
                    
                    
                </ul>
            </ul> -->
            <ul>
                <li><a href="/research/code/intro.html">Code Reviews</a></li>
                <ul>
                    
                    
                    <li><a href="/research/code/Horizon.html">Horizon Bridge</a></li>
                    
                    <li><a href="/research/code/ethereum-near.html">Ethereum Near Bridging</a></li>
                    
                    <li><a href="/research/code/ethereum.html">Ethereum</a></li>
                    
                </ul>
            </ul>
            <!-- <ul>
                <li><a href="/research/misc/intro.html">Additional Research</a></li>
                <ul>
                    
                    
                </ul>
            </ul> -->
        </header>
        <section>
            <nav>
    
    <a href="/" >Home</a>
    
    <a href="/work.html" >My Work</a>
    
    <a href="/colleagues.html" >Colleagues</a>
    
    <a href="/posts.html" >Posts</a>
    
    <a href="/research.html" >Research</a>
    
</nav>
            <style>
                sup {
                    font-size: 0.8rem;
                    position: relative;
                    top: -0.5rem;
                }
            </style>
            <h1>Polygon</h1>
            <!-- <h6><h2 id="overview">Overview</h2>
</h6> -->
            <!-- <div>Feb 4th, 2023</div>
            <div></div>
            <div><i></i></div> --->
            <h2 id="overview">Overview</h2>

<p>Polygon is representative because it uses ECDSA on secp256k1 and a relatively fixed validator set.</p>

<p>The consensus protocol is based on Peppermint<sup><a href="#f8">8</a></sup>, a modified version of Tendermint. Validators sign produced blocks using the ECDSA  signature scheme on secp256k1 curves<sup><a href="#f9">9</a></sup>. Currently, the validator set size is fixed at 100 and only changes when a current validator resigns. This restriction will change when a new auction mechanism is implemented.<sup><a href="#f10">10</a></sup></p>

<h2 id="consensus-mechanism">Consensus Mechanism</h2>

<p>Polygon uses Peppermint (a modified version of tendermint) Consensus.</p>

<p>Following is an excerpt from <a href="https://github.com/maticnetwork/matic-docs/blob/master/docs/pos/polygon-architecture.md">Polygon Architecture</a>.</p>

<p><strong>Polygon Architecture</strong></p>
<blockquote>
  <p>Heimdall is the proof of stake validation layer that handles the aggregation of blocks produced by Bor into a Merkle tree and publishes the Merkle root periodically to the root chain. The periodic publishing of snapshots of the Bor sidechain is called checkpoints.</p>

  <ol>
    <li>Validates all the blocks since the last checkpoint.</li>
    <li>Creates a Merkle tree of the block hashes.</li>
    <li>Publishes the Merkle root hash to the Ethereum mainnet.</li>
  </ol>

  <p>Checkpoints are important for two reasons:</p>

  <ol>
    <li>Providing finality on the root chain.</li>
    <li>Providing proof of burn in withdrawal of assets.</li>
  </ol>

  <p>An overview of the process:</p>

  <ul>
    <li>A subset of active validators from the pool is selected to act as <a href="/docs/maintain/glossary#block-producer">block producers</a> for a <a href="/docs/maintain/glossary#span">span</a>. These block producers are responsible for creating blocks and broadcasting the created blocks on the network.</li>
    <li>A checkpoint includes the Merkle root hash of all blocks created during any given interval. All nodes validate the Merkle root hash and attach their signature to it.</li>
    <li>A selected <a href="/docs/maintain/glossary#proposer">proposer</a> from the validator set is responsible for collecting all signatures for a particular checkpoint and committing the checkpoint on the Ethereum mainnet.</li>
    <li>The responsibility of creating blocks and proposing checkpoints is variably dependent on a validator’s stake ratio in the overall pool.</li>
  </ul>

  <p>More details on Heimdall are available on the <a href="/docs/pos/heimdall/overview">Heimdall architecture</a> guide.</p>
</blockquote>

<p>This image from <a href="https://wiki.polygon.technology/docs/pos/bor/">Bor Architecture</a> helps give a better understanding of how Ethereum, Heimdall and Bor work together.</p>

<p><img src="/assets/research/matic_structure.png" alt="Matic Structure" title="Matic Structure" /></p>

<h2 id="signing-mechanism">Signing Mechanism</h2>

<p>Following is an excerpt from and <a href="https://github.com/maticnetwork/matic-docs/blob/master/docs/pos/peppermint.md">Peppermint.md</a>.</p>

<blockquote>
  <p>Peppermint is a modified Tendermint. It is changed to make it compatible with Ethereum addresses and verifiable on Ethereum chain.</p>

  <p>Overview</p>

  <ol>
    <li>Changes to signature scheme</li>
    <li>Changes to <code class="language-plaintext highlighter-rouge">vote</code> to make it verifiable on Ethereum smart contract</li>
    <li>Changes to <code class="language-plaintext highlighter-rouge">vote</code> encoding scheme</li>
  </ol>

  <p>Peppermint uses <code class="language-plaintext highlighter-rouge">secp256k1</code> signature scheme to verify Tendermint votes on solidity smart contract.</p>

  <p>Source: <a href="https://github.com/maticnetwork/tendermint/blob/peppermint/crypto/secp256k1/secp256k1_nocgo.go">https://github.com/maticnetwork/tendermint/blob/peppermint/crypto/secp256k1/secp256k1_nocgo.go</a></p>

  <p>It adds <code class="language-plaintext highlighter-rouge">Data</code> field into <code class="language-plaintext highlighter-rouge">Vote</code> and <code class="language-plaintext highlighter-rouge">Proposal</code> struct to get <code class="language-plaintext highlighter-rouge">hash</code> for transactions in the block. On smart contract, it checks if <code class="language-plaintext highlighter-rouge">Data</code> matches with checkpoint data hash and majority (⅔+1) of validator signatures. The idea is to verify if majority of the validator set agrees on transaction in the contract.</p>

  <p>Peppermint uses RLP to get <code class="language-plaintext highlighter-rouge">Vote</code> bytes instead of Amino encoding. Here <code class="language-plaintext highlighter-rouge">Data</code> is <code class="language-plaintext highlighter-rouge">Txs.Hash()</code> for the block.</p>

  <p>Source: <a href="https://github.com/maticnetwork/tendermint/blob/peppermint/types/canonical.go">https://github.com/maticnetwork/tendermint/blob/peppermint/types/canonical.go</a></p>
</blockquote>

<blockquote>
  <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// [peppermint] create RLP vote to decode in contract</span>
<span class="k">type</span> <span class="n">CanonicalRLPVote</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">ChainID</span> <span class="kt">string</span>
 <span class="n">Type</span>    <span class="kt">byte</span>
 <span class="n">Height</span>  <span class="kt">uint</span>
 <span class="n">Round</span>   <span class="kt">uint</span>
 <span class="n">Data</span>    <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>
</code></pre></div>  </div>

  <p>And using RLP encoding lib to get byte data for signature on Vote.</p>

  <p>Source: <a href="https://github.com/maticnetwork/tendermint/blob/peppermint/types/vote.go#L75-L82">https://github.com/maticnetwork/tendermint/blob/peppermint/types/vote.go#L75-L82</a></p>
</blockquote>

<blockquote>
  <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">vote</span> <span class="o">*</span><span class="n">Vote</span><span class="p">)</span> <span class="n">SignBytes</span><span class="p">(</span><span class="n">chainID</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
 <span class="c">// [peppermint] converted from amino to rlp</span>
 <span class="n">bz</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rlp</span><span class="o">.</span><span class="n">EncodeToBytes</span><span class="p">(</span><span class="n">CanonicalizeVote</span><span class="p">(</span><span class="n">chainID</span><span class="p">,</span> <span class="n">vote</span><span class="p">))</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">bz</span>
<span class="p">}</span>
</code></pre></div>  </div>

  <p>Complete Source: <a href="https://github.com/maticnetwork/tendermint">https://github.com/maticnetwork/tendermint</a></p>
</blockquote>

<p><strong>Note: As of March 12th, 2023 the pepperming votes function now uses amino</strong></p>

<p><a href="https://github.com/maticnetwork/tendermint/blob/peppermint/types/vote.go">tendermint/types/vote.go</a></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">vote</span> <span class="o">*</span><span class="n">Vote</span><span class="p">)</span> <span class="n">SignBytes</span><span class="p">(</span><span class="n">chainID</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
 <span class="c">// [peppermint] converted from amino to rlp</span>
 <span class="n">bz</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">cdc</span><span class="o">.</span><span class="n">MarshalBinaryLengthPrefixed</span><span class="p">(</span><span class="n">CanonicalizeVote</span><span class="p">(</span><span class="n">chainID</span><span class="p">,</span> <span class="n">vote</span><span class="p">))</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">bz</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="https://github.com/maticnetwork/tendermint/blob/peppermint/consensus/codec.go">tendermint/consensus/codec.go</a></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">consensus</span>

<span class="k">import</span> <span class="p">(</span>
 <span class="n">amino</span> <span class="s">"github.com/tendermint/go-amino"</span>
 <span class="s">"github.com/tendermint/tendermint/types"</span>
<span class="p">)</span>

<span class="k">var</span> <span class="n">cdc</span> <span class="o">=</span> <span class="n">amino</span><span class="o">.</span><span class="n">NewCodec</span><span class="p">()</span>

<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">RegisterConsensusMessages</span><span class="p">(</span><span class="n">cdc</span><span class="p">)</span>
 <span class="n">RegisterWALMessages</span><span class="p">(</span><span class="n">cdc</span><span class="p">)</span>
 <span class="n">types</span><span class="o">.</span><span class="n">RegisterBlockAmino</span><span class="p">(</span><span class="n">cdc</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div></div>

<p><a href="https://github.com/maticnetwork/tendermint/blob/peppermint/p2p/codec.go">tendermint/p2p/codec.go</a></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">p2p</span>

<span class="k">import</span> <span class="p">(</span>
 <span class="n">amino</span> <span class="s">"github.com/tendermint/go-amino"</span>
 <span class="n">cryptoAmino</span> <span class="s">"github.com/tendermint/tendermint/crypto/encoding/amino"</span>
<span class="p">)</span>

<span class="k">var</span> <span class="n">cdc</span> <span class="o">=</span> <span class="n">amino</span><span class="o">.</span><span class="n">NewCodec</span><span class="p">()</span>

<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">cryptoAmino</span><span class="o">.</span><span class="n">RegisterAmino</span><span class="p">(</span><span class="n">cdc</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="code-review">Code Review</h2>

<p>Polygon’s <a href="https://github.com/maticnetwork/tendermint">peppermint fork of tendermint</a> was forked from <a href="https://github.com/tendermint/tendermint">tendermint</a> and as such the codebase has similar functions to those documented in <a href="./cosmos#code-review">cosmos code review</a>.</p>

<p>The major changes are to the consensus and signing (see above)</p>

<p>Polygon’s <a href="https://github.com/maticnetwork/bor">bor</a> is cloned from <a href="https://github.com/ethereum/go-ethereum">geth</a> and as such the codebase has similar functions to those documented in <a href="./ethereum-1-0#code-review">ethereum 1-0 code review</a>.</p>

<h3 id="signing">Signing</h3>

<ul>
  <li><a href="https://github.com/maticnetwork/tendermint/tree/peppermint/crypto/secp256k1">Peppermint secp256k1 Codebase</a>: Peppermint ECDSA Secp256k1 curve codebase (go).
    <ul>
      <li><a href="https://github.com/maticnetwork/tendermint/blob/peppermint/crypto/secp256k1/secp256k1_nocgo.go#L21">Peppermint secp256k1 signing code</a>: Peppermint sign function (go). <em>Sign creates an ECDSA signature on curve Secp256k1, using SHA256 on the msg. The returned signature will be of the form R <code class="language-plaintext highlighter-rouge">||</code> S (in lower-S form).</em></li>
    </ul>
  </li>
</ul>

<h3 id="consensus">Consensus</h3>

<ul>
  <li><a href="https://github.com/maticnetwork/tendermint">Peppermint</a>
    <ul>
      <li><a href="https://github.com/maticnetwork/tendermint/blob/peppermint/consensus/state.go#L886">state.go</a>: Modified to support <a href="https://wiki.polygon.technology/docs/pos/heimdall/overview">heimdall</a>.</li>
    </ul>
  </li>
</ul>

<h2 id="references">References</h2>

<p><strong>Consensus</strong></p>

<ul>
  <li><a href="https://arxiv.org/pdf/1807.04938.pdf">The latest gossip on BFT consensus</a>: The paper presents Tendermint, a new protocol for ordering events in a distributed network under adversarial conditions.</li>
  <li><a href="https://wiki.polygon.technology/docs/pos/heimdall/overview/">Heimdall Documentation</a>: Heimdall consensus engine uses the Cosmos-SDK and a forked version of Tendermint, called Peppermint.</li>
  <li><a href="https://wiki.polygon.technology/docs/pos/peppermint/">Peppermint Documentation</a>: Peppermint is a modified Tendermint. It is changed to make it compatible with Ethereum addresses and verifiable on Ethereum chain.</li>
  <li><a href="https://github.com/maticnetwork/tendermint/tree/peppermint">Peppermint Codebase</a>: Polygon fork of tendermint codebase (go).
    <ul>
      <li><a href="https://github.com/maticnetwork/tendermint/blob/peppermint/consensus/state.go#L70">Peppermint Consensus Code</a>: Peppermint Consensus (go). <em>ConsensusState handles execution of the consensus algorithm. It processes votes and proposals, and upon reaching agreement, commits blocks to the chain and executes them against the application. The internal state machine receives input from peers, the internal validator, and from a timer.</em></li>
      <li><a href="https://github.com/maticnetwork/tendermint/blob/master/config/config.go#L443">Peppermint Consenus Configuration Code</a>: Peppermint Consensus Configuration(go). <em>defines the configuration for the Tendermint consensus service, including timeouts and details about the Write Ahead Logs (WAL) and the block structure.</em></li>
      <li><a href="https://github.com/maticnetwork/tendermint/blob/peppermint/types/validator_set.go">Peppermint Validator Set Code</a>: Peppermint Validators (go). <em>ValidatorSet represent a set of</em>Validator at a given height.*</li>
    </ul>
  </li>
  <li><a href="https://wiki.polygon.technology/docs/pos/bor/consensus/">Bor Consensus Documentation</a>: Bor consensus is inspired by Clique consensus: <a href="https://eips.ethereum.org/EIPS/eip-225">https://eips.ethereum.org/EIPS/eip-225</a>.</li>
  <li><a href="https://eips.ethereum.org/EIPS/eip-225">EIP-225: Clique proof-of-authority consensus protocol</a>: Clique is a proof-of-authority consensus protocol. It shadows the design of Ethereum mainnet, so it can be added to any client with minimal effort.</li>
  <li><a href="https://polygon.technology/blog/heimdall-and-bor">Heimdall and Bor Article</a>: Article explaining Polygon(Matic) hybrid Plasma + Proof-of-Stake (PoS) platform.</li>
</ul>

<p><strong>Staking</strong></p>

<ul>
  <li><a href="https://wiki.polygon.technology/docs/pos/heimdall/modules/staking/">Hemidall Staking Documentation</a></li>
  <li><a href="https://staking.polygon.technology/">Polygon Staking App</a>: Polygon Staking Application listing 100 validators</li>
</ul>

<p><strong>Additional</strong></p>

<p><a name="f8">[8]</a><a name="f9">[9]</a> See notes and links to code in <a href="https://wiki.polygon.technology/docs/pos/peppermint/">Peppermint summary</a></p>

<p><a name="f10">[10]</a> See Polygon validator <a href="https://wiki.polygon.technology/docs/maintain/validate/validator-responsibilities/">documentations</a></p>

        </section>
    </div>
</body>

</html>